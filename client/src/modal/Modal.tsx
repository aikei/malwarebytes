import React from 'react'

import { useSelector, useDispatch } from 'react-redux';
import { closeModal } from '../store/modalSlice';
import { addToCart, removeFromCart } from '../store/cartSlice';
import { changeQuantity } from '../store/devicesSlice';
import { State } from '../store/store';

const Modal: React.FC = () => {

  const modalOpen = useSelector<any>((state) => state.modal.open);
  const selectedItem = useSelector<any,{type:string,id:string,name:string,description:string,price:number,quantity:number}|null>((state) => state.modal.selectedItem);
  const cartItems = useSelector<State,any[]>((state) => state.cart.items);
  const selectedItemsInCart = cartItems.filter((item) => selectedItem && item === selectedItem.id);
  const selectedItemId = (selectedItem && selectedItem.id) || '';
  const quantity = useSelector<State,number>((state) => state.devices.quantities[selectedItemId])
  const accessToken = useSelector<State,string>((state) => state.info.accessToken);

  const dispatch = useDispatch();
  return (
    <div className="modal" role="dialog" style={{display: modalOpen ? 'block' : 'none'}}>
      <div className="modal-dialog modal-lg" role="document">
        <div className="modal-content">
          <div className="modal-header">
            <h5 className="modal-title">Modal</h5>
            <button type="button" className="btn-close" data-dismiss="modal" aria-label="Close" onClick={() => dispatch(closeModal())}></button>
          </div>
          <div className="modal-body container">
            <div className='d-flex flex-row row'>
              <div className='d-flex flex-column col-8'>
                <div>
                  <b>{selectedItem?.name}</b>
                </div>
                <div style={{textAlign: 'start'}}>
                  {selectedItem?.description}
                </div>
              </div>
              <div className='d-flex flex-column col-3 justify-content-between'>
                <div className='d-flex flex-row justify-content-between m-10' style={{width: '100px'}}>
                  <div><b>{selectedItem?.price}$</b></div>
                  <input value={quantity} style={{ width: '50px' }}/>
                </div>
                <button type="button" className="btn btn-success m-1"onClick={() => {
                  if (selectedItem && quantity > 0) {
                    dispatch(changeQuantity({ deviceId: selectedItem.id, changeBy: -1 }));
                    dispatch(addToCart({ item: selectedItem, id: accessToken }));
                  }
                }}>Add to cart</button>
                <button type="button" className="btn btn-warning m-1" onClick={() => {
                  if (selectedItemsInCart.length > 0) {
                    dispatch(changeQuantity({ deviceId: selectedItem?.id, changeBy: 1 }));
                    dispatch(removeFromCart({ item: selectedItem, id: accessToken }));
                  }
                }}>Remove from cart</button>
                <div>This items in card: {selectedItemsInCart.length}</div>
                <button type="button" className="btn btn-primary m-1" onClick={() => dispatch(closeModal())}>Close</button>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  )
}

export default Modal;